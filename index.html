<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Noor Arfa – Request for Quotation</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <main class="max-w-6xl mx-auto px-4 py-8">
    <section class="bg-white shadow-sm rounded-2xl p-6">
      <h2 class="text-lg font-semibold mb-4"># CUSTOMER INFORMATION</h2>
      <form id="rfqForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="md:col-span-2">
          <label for="fullName" class="block text-sm font-medium">Masukkan Full Name</label>
          <input id="fullName" name="fullName" type="text" class="mt-1 w-full rounded-xl border-gray-300 px-3 py-2" />
        </div>
        <div>
          <label for="email" class="block text-sm font-medium">Masukkan Email Address</label>
          <input id="email" name="email" type="email" class="mt-1 w-full rounded-xl border-gray-300 px-3 py-2" />
        </div>
        <div>
          <label for="phone" class="block text-sm font-medium">Masukkan Phone Number</label>
          <input id="phone" name="phone" type="tel" class="mt-1 w-full rounded-xl border-gray-300 px-3 py-2" />
        </div>
        <div class="md:col-span-2">
          <label for="company" class="block text-sm font-medium">Masukkan Nama Company/Organisasi</label>
          <input id="company" name="company" type="text" class="mt-1 w-full rounded-xl border-gray-300 px-3 py-2" />
        </div>
        <div class="md:col-span-2">
          <label for="address" class="block text-sm font-medium">Masukkan Alamat</label>
          <textarea id="address" name="address" rows="3" class="mt-1 w-full rounded-xl border-gray-300 px-3 py-2"></textarea>
        </div>

        <!-- PIC -->
        <div>
          <label for="picName" class="block text-sm font-medium">Nama PIC</label>
          <input id="picName" name="picName" type="text" class="mt-1 w-full rounded-xl border-gray-300 px-3 py-2" />
        </div>
        <div>
          <label for="picRole" class="block text-sm font-medium">Jawatan</label>
          <input id="picRole" name="picRole" type="text" class="mt-1 w-full rounded-xl border-gray-300 px-3 py-2" />
        </div>

        <div class="md:col-span-2 pt-4">
          <h2 class="text-lg font-semibold mb-3"># SELECT YOUR BATIK PRODUCTS</h2>
          <div class="flex flex-col sm:flex-row gap-3">
            <label class="flex items-center gap-2 bg-gray-100 rounded-xl px-4 py-2">
              <input type="radio" name="productMode" id="modeReady" value="ready" />
              <span>Pilihan 1 — READY STOCK</span>
            </label>
            <label class="flex items-center gap-2 bg-gray-100 rounded-xl px-4 py-2">
              <input type="radio" name="productMode" id="modeCustom" value="custom" />
              <span>Pilihan 2 — CUSTOM (PRE ORDER)</span>
            </label>
          </div>
        </div>

        <!-- READY STOCK -->
        <div id="readySection" class="md:col-span-2 hidden">
          <div class="mt-4">
            <label class="block text-sm font-medium mb-2">Payment Method</label>
            <div class="flex flex-wrap gap-3">
              <label class="flex items-center gap-2 bg-white border rounded-xl px-3 py-2 cursor-pointer">
                <input type="radio" name="paymentMethodReady" value="Cash" />
                <span>Cash</span>
              </label>
              <label class="flex items-center gap-2 bg-white border rounded-xl px-3 py-2 cursor-pointer">
                <input type="radio" name="paymentMethodReady" value="E-Perolehan" />
                <span>E-Perolehan</span>
              </label>
            </div>
          </div>

          <!-- SEARCH PRODUK -->
          <div class="mt-4 flex items-center justify-between gap-3">
            <h3 class="font-semibold">Senarai Produk Ready Stock</h3>
            <input id="readySearch" type="text" placeholder="Cari produk..." class="rounded-xl border-gray-300 px-3 py-2" />
          </div>

          <!-- GRID PRODUK (setiap kad kini ada pilih kos jahit + Tambah Item) -->
          <div id="readyList" class="grid sm:grid-cols-2 lg:grid-cols-2 gap-4 mt-4 max-h-[520px] overflow-auto pr-1"></div>

          <!-- SENARAI READY DITAMBAH -->
          <div id="readyAddedWrap" class="mt-6 hidden">
            <h4 class="font-semibold mb-2">Senarai Ready Ditambah</h4>
            <div class="overflow-auto border rounded-xl">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="text-left px-3 py-2">#</th>
                    <th class="text-left px-3 py-2">Produk</th>
                    <th class="text-left px-3 py-2">Warna</th>
                    <th class="text-left px-3 py-2">Kos Jahit (kod)</th>
                    <th class="text-right px-3 py-2">Harga Kain/Unit</th>
                    <th class="text-right px-3 py-2">Kos Jahit/Unit</th>
                    <th class="text-right px-3 py-2">Qty</th>
                    <th class="text-right px-3 py-2">Jumlah</th>
                    <th class="px-3 py-2"></th>
                  </tr>
                </thead>
                <tbody id="readyAddedBody"></tbody>
              </table>
            </div>
          </div>

          <!-- RUMUS & BUTANG -->
          <div id="breakdownWrap" class="mt-6 hidden">
            <div class="mt-4 grid sm:grid-cols-2 gap-4">
              <div class="text-sm text-gray-600">
                <p><span class="font-medium">Payment:</span> <span id="bdPayment">—</span></p>
              </div>
              <div class="text-sm text-gray-700 space-y-1">
                <p class="flex justify-between"><span>Subtotal (Cash)</span> <span id="bdSubtotal" class="font-medium">RM0.00</span></p>
                <p class="flex justify-between"><span>Caj E-Perolehan (15%)</span> <span id="bdFee" class="font-medium">RM0.00</span></p>
                <p class="flex justify-between text-lg"><span class="font-semibold">Grand Total</span> <span id="bdGrand" class="font-semibold">RM0.00</span></p>
              </div>
            </div>

            <div class="flex flex-wrap items-center gap-3 mt-4">
              <button id="btnTotal" type="button" class="px-4 py-2 rounded-xl bg-purple-700 text-white">TOTAL</button>
              <button id="btnRFQ" type="button" class="px-4 py-2 rounded-xl bg-gray-900 text-white" disabled>REQUEST FOR QUOTATION</button>
            </div>
          </div>
        </div>

        <!-- CUSTOM (PRE ORDER) -->
        <div id="customSection" class="md:col-span-2 hidden">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium">Pilih Material</label>
              <select id="c_material" class="mt-1 w-full rounded-xl border-gray-300 px-3 py-2">
                <option value="">— Pilih —</option>
                <option>Paris Crepe</option>
                <option>Dubai Polycot</option>
                <option>Luxe Satin</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium">Masukkan Corak</label>
              <input id="c_pattern" type="text" placeholder="Contoh: Songket Flora Geometri" class="mt-1 w-full rounded-xl border-gray-300 px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm font-medium">Pilih Warna</label>
              <input id="c_color" type="text" placeholder="Contoh: Royal Blue" class="mt-1 w-full rounded-xl border-gray-300 px-3 py-2" />
            </div>

            <div>
              <label class="block text-sm font-medium">Meter</label>
              <input id="c_meter" type="number" min="0" step="0.5" placeholder="cth 4" class="mt-1 w-full rounded-xl border-gray-300 px-3 py-2" />
            </div>
            <div>
              <label class="block text-sm font-medium">Quantity</label>
              <input id="c_qty" type="number" min="1" placeholder="cth 10" class="mt-1 w-full rounded-xl border-gray-300 px-3 py-2" />
            </div>

            <div class="md:col-span-3">
              <label class="block text-sm font-medium">Variasi Design</label>
              <select id="c_variant" class="mt-1 w-full rounded-xl border-gray-300 px-3 py-2">
                <option value="new">New Design (RM500)</option>
                <option value="edit">Edit Design (RM150)</option>
                <option value="recolor">Tukar Warna (RM50)</option>
              </select>
              <p class="text-xs text-gray-500 mt-1">Formula: caj design/unit = harga variasi ÷ qty; unit price = caj design/unit + kos jahit/unit. Jumlah = (unit price × qty) + harga variasi + yuran add-on (jika ada).</p>
            </div>

            <!-- Add-on & Kos Jahit untuk Custom -->
            <div>
              <label class="block text-sm font-medium">Add-on</label>
              <label class="flex items-center gap-2 mt-1">
                <input id="c_addonLogo" type="checkbox" />
                <span>Tambah logo/nama sendiri (RM100)</span>
              </label>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium">Kos Jahit (kod)</label>
              <input id="c_sew" class="mt-1 w-full rounded-xl border-gray-300 px-3 py-2" list="sewOptions" placeholder="cth JHT-001" />
              <div id="c_sew_desc" class="text-xs text-gray-500 mt-1">—</div>
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-3 mt-4">
            <button id="btnAddCustom" type="button" class="px-4 py-2 rounded-xl bg-gray-200">Tambah Item</button>
            <button id="btnTotalCustom" type="button" class="px-4 py-2 rounded-xl bg-purple-700 text-white">TOTAL</button>
            <button id="btnRFQCustom" type="button" class="px-4 py-2 rounded-xl bg-gray-900 text-white" disabled>REQUEST FOR QUOTATION</button>
          </div>

          <div id="customListWrap" class="mt-4 hidden">
            <h4 class="font-semibold mb-2">Senarai Custom Ditambah</h4>
            <div class="overflow-auto border rounded-xl">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-100">
                  <tr>
                    <th class="text-left px-3 py-2">#</th>
                    <th class="text-left px-3 py-2">Butiran</th>
                    <th class="text-left px-3 py-2">Sew (kod)</th>
                    <th class="text-left px-3 py-2">Add-on</th>
                    <th class="text-right px-3 py-2">Caj Design/Unit</th>
                    <th class="text-right px-3 py-2">Kos Jahit/Unit</th>
                    <th class="text-right px-3 py-2">Qty</th>
                    <th class="text-right px-3 py-2">Jumlah (Cash)</th>
                    <th class="px-3 py-2"></th>
                  </tr>
                </thead>
                <tbody id="customListBody"></tbody>
              </table>
            </div>

            <div class="mt-4 grid sm:grid-cols-2 gap-4">
              <div class="text-sm text-gray-600">
                <p><span class="font-medium">Payment:</span> <span id="cbdPayment">—</span></p>
              </div>
              <div class="text-sm text-gray-700 space-y-1">
                <p class="flex justify-between"><span>Subtotal (Cash)</span> <span id="cbdSubtotal" class="font-medium">RM0.00</span></p>
                <p class="flex justify-between"><span>Caj E-Perolehan (15%)</span> <span id="cbdFee" class="font-medium">RM0.00</span></p>
                <p class="flex justify-between text-lg"><span class="font-semibold">Grand Total</span> <span id="cbdGrand" class="font-semibold">RM0.00</span></p>
              </div>
            </div>
          </div>
        </div>
      </form>
    </section>

    <!-- QUOTATION (format contoh penuh) -->
    <section id="quotationSection" class="bg-white shadow-sm rounded-2xl p-6 mt-8 hidden print:block">
      <div class="text-center mb-2">
        <img src="logo-noorarfa.jpg" alt="Noor Arfa" class="mx-auto h-10 mb-2">
        <p class="font-semibold tracking-wide">NOOR ARFA ONLINE EMPIRE SDN BHD</p>
        <p class="text-sm">202101009431 (1409730-X)</p>
        <p class="text-sm">LOT 4153, KAWASAN PERINDUSTRIAN CHENDERING, 21080 KUALA TERENGGANU, TERENGGANU DARUL IMAN, MALAYSIA.</p>
      </div>

      <h2 class="text-xl font-bold text-center my-3">INVOICE</h2>

      <div class="grid md:grid-cols-2 gap-4 text-sm mb-2">
        <div class="border p-3 rounded">
          <p id="qCustLine1">—</p>
          <p id="qCustLine2">—</p>
          <p id="qCustLine3">—</p>
          <p id="qCustLine4">—</p>
        </div>
        <div class="border p-3 rounded">
          <div class="flex justify-between"><span>INVOICE NO</span><span id="qInvNo">—</span></div>
          <div class="flex justify-between"><span>DATE</span><span id="qDate">—</span></div>
          <div class="flex justify-between"><span>REFERENCE</span><span id="qRef">—</span></div>
          <div class="flex justify-between"><span>TERM</span><span id="qTerm">30 DAYS</span></div>
          <div class="flex justify-between"><span>SALESPERSON</span><span id="qSales">CA</span></div>
        </div>
      </div>

      <div class="overflow-auto border rounded-xl">
        <table class="min-w-full text-sm invoice-table">
          <thead>
            <tr>
              <th>NO</th>
              <th>ITEM CODE</th>
              <th>DESCRIPTION</th>
              <th>QTY</th>
              <th>UOM</th>
              <th>UNIT PRICE</th>
              <th>AMOUNT</th>
            </tr>
          </thead>
          <tbody id="qBody"></tbody>
        </table>
      </div>

      <div class="grid md:grid-cols-2 gap-4 mt-3 text-sm">
        <div class="border rounded p-3">
          <div class="flex items-start gap-2">
            <span class="whitespace-nowrap">RINGGIT MALAYSIA:</span>
            <span id="qInWords" class="font-medium">—</span>
          </div>
          <div class="mt-2 text-xs text-gray-500">Customer Signature/Customer's Stamp</div>
        </div>
        <div class="border rounded p-3">
          <div class="flex justify-between"><span>DISCOUNT :</span><span id="qDiscount">0.00</span></div>
          <div class="flex justify-between text-lg font-semibold mt-1"><span>TOTAL :</span><span id="qGrand">RM0.00</span></div>
        </div>
      </div>

      <div class="mt-3 text-sm space-y-1">
        <p>BANK NO: <span>563019300868 (MAYBANK SDN BHD MBB868)</span></p>
        <p>BANK NAME: <span>MAYBANK SDN BHD</span></p>
        <p>BANK HOLDER: <span>NOOR ARFA ONLINE EMPIRE SDN BHD</span></p>
      </div>

      <div class="mt-3 grid md:grid-cols-2 gap-6">
        <div class="border rounded p-3">
          <div class="h-20"></div>
          <div class="border-t pt-2 text-sm">
            <p class="text-gray-600">Customer Signature/Customer's Stamp</p>
          </div>
        </div>
        <div class="border rounded p-3">
          <div class="h-20"></div>
          <div class="border-t pt-2 text-right text-sm">
            <p id="qStaff">ANIS SOLEHAH (PEGAWAI WEBSITE)</p>
            <p>NOOR ARFA HOLDINGS SDN BHD</p>
          </div>
        </div>
      </div>

      <div class="text-right text-xs text-gray-500 mt-2">Page 1 of 1</div>

      <div class="mt-4 no-print flex gap-3">
        <button onclick="window.print()" class="px-4 py-2 rounded-xl bg-purple-700 text-white">Print / Save PDF</button>
        <button id="btnSubmitOrder" class="px-4 py-2 rounded-xl bg-green-600 text-white" disabled>SUBMIT ORDER</button>
      </div>
    </section>
  </main>

  <!-- DATASENARAI KOS JAHIT (untuk search ikut KOD) -->
  <datalist id="sewOptions"></datalist>

  <script>
    /* =========================================================
       CONFIG
       ========================================================= */
    const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyNI2yAu9SYE3JHFSXxbXIXxiAx_tqoN8bQ2BwBqX2HyR5oCNm-N5u6VS_om8sFKrD_Tg/exec"; // tukar jika perlu
    const DEFAULT_SHIPPING_METHOD = "Courier";
    const E_PEROLEHAN_RATE = 0.15;
    const ADDON_LOGO_FEE = 100; // add-on logo utk custom (one-off per item)

    /* =========================================================
       READY PRODUCT LIST + HARGA
       ========================================================= */
    const READY_PRODUCTS = [
      { name:"BATIK AYUNI (DUBAI CREPE)", colors:["Grey","Green","Pink","Royal Blue","Brick Red"], pricing:q=>(q>=10?90:q>=5?109:119) },
      { name:"BATIK NURA (DUBAI CREPE)", colors:["Grey","Lavender","Pink","Olive Green","Royal Blue"], pricing:q=>(q>=10?90:q>=5?109:119) },
      { name:"BATIK AFIYA (DUBAI CREPE)", colors:["Grey","Burgundy","Plum","Olive Green","Navy Blue"], pricing:q=>(q>=10?90:q>=5?109:119) },
      { name:"BATIK MARSYA (DUBAI CREPE)", colors:["Moss Green","Red","Violet Purple","Royal Blue","Grey"], pricing:q=>(q>=10?90:q>=5?109:119) },
      { name:"KAIN PASANG NONEE (ROYAL SATIN)", colors:["Emerald Green","Royal Blue"], pricing:q=>(q>=10?119:q>=5?139:159) },
      { name:"KAIN PASANG NURISHA (ROYAL SATIN)", colors:["Black"], pricing:q=>109 },
      { name:"KAIN PASANG MICRO COTTON - 4M BIDANG 60", colors:["Royal Blue"], pricing:q=>99 },
      { name:"KAIN PASANG MARIA POLY COTTON - 4M BIDANG 59", colors:["Black"], pricing:q=>(q>=10?79:q>=5?89:99) },
      { name:"KAIN PASANG PERSIAN CREPE - 4M BIDANG 60", colors:["Chili Red"], pricing:q=>99 },
      { name:"KAIN PASANG PARIS CREPE BATIK SARA - 4M BIDANG 60", colors:["Maroon","Black"], pricing:q=>(q>=10?129:q>=5?139:149) },
      { name:"KAIN PASANG HANIFARA (TWILLY VELVET) - 4M BIDANG 55", colors:["Light Pink","Matcha","Light Peach","Soft Grey","Sky Blue","Yellow","Butter Yellow","Peach Pink","Lilac","Orange"], pricing:q=>(q>=5?45:55) },
      { name:"KAIN PASANG AIRA/ALYA/DHIA (ITALIAN CREPE) - 4M BIDANG 60", colors:["Maroon","Purple","Blue","Black","Greenish Yellow","Deep Blue","Green","Mustard"], pricing:q=>70 },
      { name:"KAIN PASANG SWISS SATIN - 4M BIDANG 60", colors:["Royal Blue","Maroon","Emerald Green","Black","Soft Brown"], pricing:q=>(q>=10?99:q>=5?109:q>=3?119:129) },
      { name:"KAIN PASANG LILY (FRENCH CREPE) - 4M BIDANG 60", colors:["Black","Maroon","Olive Green","Purple Violet","Rose Pink"], pricing:q=>(q>=10?89:99) },
    ];
    const READY_SKU_MAP = {
      "BATIK AYUNI (DUBAI CREPE)": {
        "Grey":"ZA3763","Green":"AYUNI-GREEN","Pink":"AYUNI-PINK","Royal Blue":"AYUNI-RBLUE","Brick Red":"AYUNI-BRED"
      },
      "BATIK NURA (DUBAI CREPE)": {
        "Grey":"NURA-GREY","Lavender":"NURA-LAVENDER","Pink":"NURA-PINK","Olive Green":"NURA-OLIVE","Royal Blue":"NURA-RBLUE"
      },
      "BATIK AFIYA (DUBAI CREPE)": {
        "Grey":"AFIYA-GREY","Burgundy":"AFIYA-BURG","Plum":"AFIYA-PLUM","Olive Green":"AFIYA-OLIVE","Navy Blue":"AFIYA-NAVY"
      },
      "BATIK MARSYA (DUBAI CREPE)": {
        "Moss Green":"MARSYA-MOSS","Red":"MARSYA-RED","Violet Purple":"MARSYA-VIOLET","Royal Blue":"MARSYA-RBLUE","Grey":"MARSYA-GREY"
      },
      "KAIN PASANG NONEE (ROYAL SATIN)": {
        "Emerald Green":"NONEE-EMERALD","Royal Blue":"NONEE-RBLUE"
      },
      "KAIN PASANG NURISHA (ROYAL SATIN)": {
        "Black":"NURISHA-BLACK"
      },
      "KAIN PASANG MICRO COTTON - 4M BIDANG 60": {
        "Royal Blue":"MC60-RBLUE"
      },
      "KAIN PASANG MARIA POLY COTTON - 4M BIDANG 59": {
        "Black":"MARIA59-BLACK"
      },
      "KAIN PASANG PERSIAN CREPE - 4M BIDANG 60": {
        "Chili Red":"PERSIAN60-CHILI"
      },
      "KAIN PASANG PARIS CREPE BATIK SARA - 4M BIDANG 60": {
        "Maroon":"SARA60-MAROON","Black":"SARA60-BLACK"
      },
      "KAIN PASANG HANIFARA (TWILLY VELVET) - 4M BIDANG 55": {
        "Light Pink":"HANIFARA55-LPINK","Matcha":"HANIFARA55-MATCHA","Light Peach":"HANIFARA55-LPEACH","Soft Grey":"HANIFARA55-SGREY","Sky Blue":"HANIFARA55-SKY","Yellow":"HANIFARA55-YELLOW","Butter Yellow":"HANIFARA55-BYELLOW","Peach Pink":"HANIFARA55-PEACHP","Lilac":"HANIFARA55-LILAC","Orange":"HANIFARA55-ORANGE"
      },
      "KAIN PASANG AIRA/ALYA/DHIA (ITALIAN CREPE) - 4M BIDANG 60": {
        "Maroon":"AAD60-MAROON","Purple":"AAD60-PURPLE","Blue":"AAD60-BLUE","Black":"AAD60-BLACK","Greenish Yellow":"AAD60-GYELLOW","Deep Blue":"AAD60-DBLUE","Green":"AAD60-GREEN","Mustard":"AAD60-MUSTARD"
      },
      "KAIN PASANG SWISS SATIN - 4M BIDANG 60": {
        "Royal Blue":"SWISS60-RBLUE","Maroon":"SWISS60-MAROON","Emerald Green":"SWISS60-EMERALD","Black":"SWISS60-BLACK","Soft Brown":"SWISS60-SBROWN"
      },
      "KAIN PASANG LILY (FRENCH CREPE) - 4M BIDANG 60": {
        "Black":"LILY60-BLACK","Maroon":"LILY60-MAROON","Olive Green":"LILY60-OLIVE","Purple Violet":"LILY60-PVIOLET","Rose Pink":"LILY60-RPINK"
      }
    };

    /* =========================================================
       KOS JAHIT (contoh – ganti dgn senarai sebenar)
       ========================================================= */
    const SEWING_OPTIONS = [
      { code: "JHT-000", name: "Hemming Basic / Jahit Tepi", price: 8 },
      { code: "JHT-001", name: "Baju Kurung", price: 35 },
      { code: "JHT-002", name: "Kebaya", price: 45 },
      { code: "JHT-003", name: "Jubah", price: 50 },
      { code: "JHT-004", name: "Shawl Hemming", price: 10 },
      { code: "JHT-005", name: "Seluar / Slack", price: 25 },
      { code: "JHT-006", name: "Baju Melayu (Dewasa)", price: 60 },
      { code: "JHT-007", name: "Baju Melayu (Kanak-kanak)", price: 40 },
      // … tambah lagi ikut template anda
    ];

    /* =========================================================
       DOM
       ========================================================= */
    const modeReady = document.getElementById('modeReady');
    const modeCustom = document.getElementById('modeCustom');
    const readySection = document.getElementById('readySection');
    const customSection = document.getElementById('customSection');

    const readyList = document.getElementById('readyList');
    const readySearch = document.getElementById('readySearch');
    const readyAddedWrap = document.getElementById('readyAddedWrap');
    const readyAddedBody = document.getElementById('readyAddedBody');

    const btnTotal = document.getElementById('btnTotal');
    const btnRFQ = document.getElementById('btnRFQ');

    const breakdownWrap = document.getElementById('breakdownWrap');
    const bdPayment = document.getElementById('bdPayment');
    const bdSubtotal = document.getElementById('bdSubtotal');
    const bdFee = document.getElementById('bdFee');
    const bdGrand = document.getElementById('bdGrand');

    const quotationSection = document.getElementById('quotationSection');
    const qBody = document.getElementById('qBody');
    const qInvNo = document.getElementById('qInvNo');
    const qDate = document.getElementById('qDate');
    const qRef = document.getElementById('qRef');
    const qTerm = document.getElementById('qTerm');
    const qSales = document.getElementById('qSales');
    const qInWords = document.getElementById('qInWords');
    const qGrand = document.getElementById('qGrand');

    const btnSubmitOrder = document.getElementById('btnSubmitOrder');

    // CUSTOM DOM
    const btnAddCustom   = document.getElementById('btnAddCustom');
    const btnTotalCustom = document.getElementById('btnTotalCustom');
    const btnRFQCustom   = document.getElementById('btnRFQCustom');
    const customListWrap = document.getElementById('customListWrap');
    const customListBody = document.getElementById('customListBody');
    const cbdPayment     = document.getElementById('cbdPayment');
    const cbdSubtotal    = document.getElementById('cbdSubtotal');
    const cbdFee         = document.getElementById('cbdFee');
    const cbdGrand       = document.getElementById('cbdGrand');

    const c_material = document.getElementById('c_material');
    const c_pattern  = document.getElementById('c_pattern');
    const c_color    = document.getElementById('c_color');
    const c_meter    = document.getElementById('c_meter');
    bigconst_c_qty_placeholder = 1;
    const c_qty      = document.getElementById('c_qty');
    const c_variant  = document.getElementById('c_variant');
    const c_addonLogo = document.getElementById('c_addonLogo');
    const c_sew       = document.getElementById('c_sew');
    const c_sew_desc  = document.getElementById('c_sew_desc');

    /* =========================================================
       HELPERS
       ========================================================= */
    const fmtRM = n => 'RM' + Number(n).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    let LAST_ORDER_PAYLOAD = null;
    let readyItems = [];
    let customItems = [];

    function toggleSections() {
      const mode = document.querySelector('input[name="productMode"]:checked')?.value;
      readySection.classList.toggle('hidden', mode !== 'ready');
      customSection.classList.toggle('hidden', mode !== 'custom');
    }
    function priceHint(prod){
      const s1 = prod.pricing(1), s5 = prod.pricing(5), s10 = prod.pricing(10);
      if (s1 !== s5 || s5 !== s10) return `Harga kain: 1–4 ${fmtRM(s1)} | 5–9 ${fmtRM(s5)} | ≥10 ${fmtRM(s10)}`;
      return "Harga kain: " + fmtRM(s1) + " /unit";
    }
    function makeFallbackSKU(productName, color){
      const p = (productName||'').replace(/[^A-Z0-9]+/gi,' ').trim().split(/\s+/).map(w=>w[0]).join('').toUpperCase();
      const c = (color||'').replace(/\s+/g,'').replace(/[^A-Za-z0-9]/g,'').toUpperCase();
      return (p? p : 'SKU') + '-' + (c? c : 'NA');
    }
    function findSewingByCode(code){
      if (!code) return null;
      const c = code.trim().toUpperCase();
      return SEWING_OPTIONS.find(o => o.code.toUpperCase() === c) || null;
    }
    function populateSewingDatalist(){
      const dl = document.getElementById('sewOptions');
      dl.innerHTML = SEWING_OPTIONS
        .sort((a,b)=>a.code.localeCompare(b.code))
        .map(o => `<option value="${o.code}">${o.name} — RM${o.price}</option>`).join('');
    }

    /* =========================================================
       READY: UI & EVENTS
       ========================================================= */
    function buildProductCard(prod, index) {
      const card = document.createElement('div');
      card.className = "border rounded-xl p-4 bg-white";
      card.dataset.index = index;
      card.innerHTML = `
        <p class="font-semibold mb-2">${prod.name}</p>

        <label class="block text-sm font-medium">Pilih Warna</label>
        <select class="w-full border rounded-xl mb-2 px-3 py-2 sel-color">
          ${prod.colors.map(c=>`<option>${c}</option>`).join('')}
        </select>

        <p class="text-sm mb-2 text-gray-700">${priceHint(prod)}</p>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <div>
            <label class="block text-sm font-medium">Quantity</label>
            <input type="number" min="1" placeholder="cth 1" class="w-full border rounded-xl px-3 py-2 inp-qty" />
          </div>
          <div>
            <label class="block text-sm font-medium">Kos Jahit (kod)</label>
            <input class="w-full border rounded-xl px-3 py-2 inp-sew" list="sewOptions" placeholder="cth JHT-001" />
            <div class="text-xs text-gray-500 mt-1 sew-desc">—</div>
          </div>
        </div>

        <div class="mt-3">
          <button type="button" class="btn-add-ready w-full sm:w-auto px-4 py-2 rounded-xl bg-gray-200">Tambah Item</button>
        </div>
      `;
      return card;
    }
    function renderProducts(list = READY_PRODUCTS) {
      readyList.innerHTML = list.map((p,i)=>buildProductCard(p,i).outerHTML).join('');
    }
    function currentPaymentReady() {
      return document.querySelector('input[name="paymentMethodReady"]:checked')?.value || null;
    }

    // INIT
    populateSewingDatalist();
    renderProducts();
    readySearch?.addEventListener('input', () => {
      const q = readySearch.value.toLowerCase();
      const filtered = READY_PRODUCTS.filter(p => p.name.toLowerCase().includes(q));
      renderProducts(filtered);
    });

    // Show desc sew on input
    readyList.addEventListener('input', (e)=>{
      if (e.target.classList.contains('inp-sew')) {
        const wrap = e.target.closest('[data-index]');
        const desc = wrap.querySelector('.sew-desc');
        const found = findSewingByCode(e.target.value);
        desc.textContent = found ? `${found.name} (${found.code}) — ${fmtRM(found.price)}` : '—';
      }
    });

    // Tambah item ready
    readyList.addEventListener('click', (e)=>{
      if (!e.target.classList.contains('btn-add-ready')) return;
      const card = e.target.closest('[data-index]');
      const idx  = Number(card.dataset.index);
      const prod = READY_PRODUCTS[idx];
      const color = card.querySelector('.sel-color').value;
      const qty   = Number(card.querySelector('.inp-qty').value || 0);
      const sewCodeInp = card.querySelector('.inp-sew').value.trim();
      if (!qty || qty<=0) { alert('Sila masukkan Quantity (>0).'); return; }

      const unitFabric = prod.pricing(qty);
      const sku = (READY_SKU_MAP[prod.name] && READY_SKU_MAP[prod.name][color]) || makeFallbackSKU(prod.name, color);

      const sew = findSewingByCode(sewCodeInp);
      const sewPrice = sew ? Number(sew.price) : 0;
      const sewCode  = sew ? sew.code : '';

      const total = (unitFabric + sewPrice) * qty;

      readyItems.push({
        name: prod.name,
        color,
        qty,
        sku,
        unitFabric,
        sewCode,
        sewPrice,
        amount: total
      });

      // reset
      card.querySelector('.inp-qty').value = '';
      card.querySelector('.inp-sew').value = '';
      card.querySelector('.sew-desc').textContent = '—';

      renderReadyAddedList();
      btnRFQ.disabled = readyItems.length===0;
      breakdownWrap.classList.remove('hidden');
    });

    function renderReadyAddedList(){
      readyAddedBody.innerHTML = readyItems.map((it,idx)=>`
        <tr>
          <td class="px-3 py-2">${idx+1}</td>
          <td class="px-3 py-2">${it.name}</td>
          <td class="px-3 py-2">${it.color}</td>
          <td class="px-3 py-2">${it.sewCode || '—'}</td>
          <td class="px-3 py-2 text-right">${fmtRM(it.unitFabric)}</td>
          <td class="px-3 py-2 text-right">${fmtRM(it.sewPrice)}</td>
          <td class="px-3 py-2 text-right">${it.qty}</td>
          <td class="px-3 py-2 text-right">${fmtRM(it.amount)}</td>
          <td class="px-3 py-2 text-right">
            <button class="text-red-600 underline btn-del-ready" data-del="${idx}">Delete</button>
          </td>
        </tr>`).join('');
      readyAddedWrap.classList.toggle('hidden', readyItems.length===0);
    }
    readyAddedBody.addEventListener('click', (e)=>{
      if (!e.target.classList.contains('btn-del-ready')) return;
      const idx = Number(e.target.dataset.del);
      readyItems.splice(idx, 1);
      renderReadyAddedList();
      btnRFQ.disabled = readyItems.length===0;
      if (readyItems.length===0) {
        bdSubtotal.textContent = 'RM0.00';
        bdFee.textContent = 'RM0.00';
        bdGrand.textContent = 'RM0.00';
      }
    });

    function computeTotalsFromReady(payment){
      const subtotal = readyItems.reduce((s,i)=> s + i.amount, 0);
      const fee = payment === 'E-Perolehan' ? subtotal * E_PEROLEHAN_RATE : 0;
      const grand = subtotal + fee;
      return { subtotal, fee, grand };
    }

    btnTotal.addEventListener('click', () => {
      const pay = currentPaymentReady();
      if (!readyItems.length) { alert('Sila tekan "Tambah Item" sekurang-kurangnya satu produk.'); return; }
      const totals = computeTotalsFromReady(pay);
      bdPayment.textContent = pay || '—';
      bdSubtotal.textContent = fmtRM(totals.subtotal);
      bdFee.textContent = fmtRM(totals.fee);
      bdGrand.textContent = fmtRM(totals.grand);
      breakdownWrap.classList.remove('hidden');
      breakdownWrap.scrollIntoView({ behavior: 'smooth' });
    });

    /* =========================================================
       CUSTOM LOGIC
       ========================================================= */
    function currentPaymentCustom() {
      return document.querySelector('input[name="paymentMethodCustom"]:checked')?.value || null;
    }

    // live desc untuk kod jahit custom
    c_sew?.addEventListener('input', ()=>{
      const opt = findSewingByCode(c_sew.value);
      c_sew_desc.textContent = opt ? `${opt.name} (${opt.code}) — ${fmtRM(Number(opt.price))}` : '—';
    });

    btnAddCustom?.addEventListener('click', addCustomItem);
    function addCustomItem(){
      const qty   = Number(c_qty.value || 0);
      const meter = Number(c_meter.value || 0);
      if (!c_material.value || !c_pattern.value || !c_color.value || !qty || qty<=0) {
        alert('Sila lengkapkan Material, Corak, Warna dan Quantity (>0).');
        return;
      }
      // Variasi (tanpa 'logo')
      const VARIANT_PRICE = { new:500, edit:150, recolor:50 };
      const variantKey  = c_variant.value;
      const vp          = VARIANT_PRICE[variantKey] || 0;     // one-off
      const designCharge = qty ? (vp / qty) : 0;              // per unit

      // Kos jahit (per unit)
      const sewOpt   = findSewingByCode(c_sew.value);
      const sewCode  = sewOpt ? sewOpt.code : '';
      const sewPrice = sewOpt ? Number(sewOpt.price) : 0;

      // Add-on logo (one-off)
      const addonLogo = !!c_addonLogo.checked;
      const addonFee  = addonLogo ? ADDON_LOGO_FEE : 0;

      // Unit price (invoice) = caj design/unit + kos jahit/unit
      const unitCombined = designCharge + sewPrice;

      // Total item = (unitCombined × qty) + vp + addonFee
      const totalCash = (unitCombined * qty) + vp + addonFee;

      customItems.push({
        material: c_material.value,
        pattern:  c_pattern.value,
        color:    c_color.value,
        meter,
        qty,
        variant:     variantKey,
        variantText: c_variant.options[c_variant.selectedIndex].text,
        variantPrice: vp,
        designCharge,
        sewCode, sewPrice,
        addonLogo, addonFee,
        unitCombined,
        totalCash
      });

      // reset
      c_meter.value = ''; c_qty.value = '';
      c_addonLogo.checked = false;
      c_sew.value=''; c_sew_desc.textContent='—';

      renderCustomList();
      btnRFQCustom.disabled = customItems.length===0;
    }

    function renderCustomList(){
      customListBody.innerHTML = customItems.map((it,idx)=>`
        <tr>
          <td class="px-3 py-2">${idx+1}</td>
          <td class="px-3 py-2">
            <div class="font-medium">${it.material} — ${it.pattern} (${it.color})</div>
            <div class="text-xs text-gray-500">Variasi: ${it.variantText}</div>
          </td>
          <td class="px-3 py-2">${it.sewCode || '—'}</td>
          <td class="px-3 py-2">${it.addonLogo ? 'Logo (RM'+Number(it.addonFee).toFixed(2)+')' : '—'}</td>
          <td class="px-3 py-2 text-right">${fmtRM(it.designCharge)}</td>
          <td class="px-3 py-2 text-right">${fmtRM(it.sewPrice)}</td>
          <td class="px-3 py-2 text-right">${it.qty}</td>
          <td class="px-3 py-2 text-right">${fmtRM(it.totalCash)}</td>
          <td class="px-3 py-2 text-right">
            <button class="text-red-600 underline" data-del="${idx}">Delete</button>
          </td>
        </tr>`).join('');
      customListWrap.classList.toggle('hidden', customItems.length===0);
    }
    customListBody.addEventListener('click', (e)=>{
      const idx = e.target?.dataset?.del;
      if (idx !== undefined) {
        customItems.splice(Number(idx), 1);
        renderCustomList();
        btnRFQCustom.disabled = customItems.length===0;
      }
    });

    function computeTotalsCustom(items, payment){
      const subtotal = items.reduce((s,i)=> s + i.totalCash, 0);
      const fee = payment === 'E-Perolehan' ? subtotal * E_PEROLEHAN_RATE : 0;
      const grand = subtotal + fee;
      return {subtotal, fee, grand};
    }

    btnTotalCustom?.addEventListener('click', () => {
      const pay = currentPaymentCustom();
      if (!pay) { alert('Sila pilih Payment Method (Cash atau E-Perolehan).'); return; }
      if (!customItems.length) { alert('Sila tambah sekurang-kurangnya satu item custom.'); return; }
      const totals = computeTotalsCustom(customItems, pay);
      cbdPayment.textContent = pay;
      cbdSubtotal.textContent = fmtRM(totals.subtotal);
      cbdFee.textContent = fmtRM(totals.fee);
      cbdGrand.textContent = fmtRM(totals.grand);
      customListWrap.classList.remove('hidden');
      customListWrap.scrollIntoView({behavior:'smooth'});
    });

    /* =========================================================
       QUOTATION
       ========================================================= */
    function populateQuotation(items, totals, payment) {
      const name = document.getElementById('fullName').value || '';
      const company = document.getElementById('company').value || '';
      const address = (document.getElementById('address').value || '').split('\n');
      const email = document.getElementById('email').value || '';
      const phone = document.getElementById('phone').value || '';
      const picName = document.getElementById('picName')?.value || '';
      const picRole = document.getElementById('picRole')?.value || '';

      document.getElementById('qCustLine1').textContent = company || name || '—';
      document.getElementById('qCustLine2').textContent = address[0] || '—';
      document.getElementById('qCustLine3').textContent = address[1] || (email ? email : '—');
      document.getElementById('qCustLine4').textContent = phone ? phone : (address[2]||'—');

      const now = new Date(); const pad = n => String(n).padStart(2,'0');
      qInvNo.textContent = `IV-NAE${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}${pad(now.getHours())}${pad(now.getMinutes())}`;
      qDate.textContent = `${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
      qRef.textContent = payment || 'CASH';
      qTerm.textContent = '30 DAYS';
      qSales.textContent = 'CA';

      qBody.innerHTML = items.map((it, idx)=>`
        <tr>
          <td>${idx+1}</td>
          <td>${it.sku || '—'}</td>
          <td>${it.desc}</td>
          <td class="text-right">${it.qty}</td>
          <td>UNIT</td>
          <td class="text-right">${fmtRM(it.unit)}</td>
          <td class="text-right">${fmtRM(it.amount)}</td>
        </tr>`).join('');

      qInWords.textContent = totals.grand>0 ? (toWordsEN(Math.round(totals.grand)) + ' RINGGIT ONLY') : '—';
      qGrand.textContent = fmtRM(totals.grand);
      document.getElementById('qDiscount').textContent = '0.00';

      document.getElementById('qStaff').textContent =
        (picName && picRole) ? `${picName.toUpperCase()} (${picRole.toUpperCase()})`
                             : 'ANIS SOLEHAH (PEGAWAI WEBSITE)';

      quotationSection.classList.remove('hidden');
      quotationSection.scrollIntoView({ behavior: 'smooth' });
    }
    function toWordsEN(num){
      const a=["","ONE","TWO","THREE","FOUR","FIVE","SIX","SEVEN","EIGHT","NINE","TEN","ELEVEN","TWELVE","THIRTEEN","FOURTEEN","FIFTEEN","SIXTEEN","SEVENTEEN","EIGHTEEN","NINETEEN"];
      const b=["","","TWENTY","THIRTY","FORTY","FIFTY","SIXTY","SEVENTY","EIGHTY","NINETY"];
      const g=[""," THOUSAND"," MILLION"," BILLION"];
      if(num===0) return "ZERO";
      let words="", i=0;
      while(num>0){
        let chunk = num%1000;
        if(chunk){
          let str="";
          if(chunk>99){ str+=a[Math.floor(chunk/100)]+" HUNDRED "; chunk%=100; }
          if(chunk>19){ str+=b[Math.floor(chunk/10)]+" "; chunk%=10; }
          if(chunk>0){ str+=a[chunk]+" "; }
          words = str.trim()+g[i]+" "+words;
        }
        num=Math.floor(num/1000); i++;
      }
      return words.trim();
    }

    /* =========================================================
       HANTAR KE GOOGLE SHEETS
       ========================================================= */
    async function sendToSheets(payload) {
      try {
        const res = await fetch(SHEETS_WEBAPP_URL, {
          method: 'POST',
          headers: {'Content-Type': 'text/plain'}, // elak preflight
          body: JSON.stringify(payload)
        });
        let msg = 'Order dihantar ke Google Sheets.';
        try {
          const data = await res.json();
          if (data?.ok && data?.orderId) msg = `Order dihantar! Order ID: ${data.orderId}`;
        } catch(_) {}
        alert(msg);
      } catch (err) {
        console.error(err);
        alert('Maaf, gagal hantar ke Google Sheets. Cuba lagi.');
      }
    }

    /* =========================================================
       RFQ BUTTONS (READY & CUSTOM)
       ========================================================= */
    function collectCustomerForPayload(){
      const addr = (document.getElementById('address').value || '').split('\n');
      return {
        fullName: document.getElementById('fullName').value || '',
        email: document.getElementById('email').value || '',
        phone: document.getElementById('phone').value || '',
        company: document.getElementById('company').value || '',
        address_line1: addr[0] || '',
        address_line2: addr[1] || '',
        address_line3: addr.length>2 ? addr.slice(2).join(' ') : ''
      };
    }

    // READY → RFQ
    btnRFQ.addEventListener('click', () => {
      const pay = currentPaymentReady();
      if (!readyItems.length) { alert('Sila tambah sekurang-kurangnya satu item (button "Tambah Item").'); return; }
      const totals = computeTotalsFromReady(pay);

      const itemsForInvoice = readyItems.map(i => ({
        sku: i.sku,
        desc: i.name + ' ('+i.color+')' + (i.sewCode ? ` [Sew ${i.sewCode}]` : ''),
        qty: i.qty,
        unit: i.unitFabric + (i.sewPrice||0),
        amount: i.amount
      }));

      const customer = collectCustomerForPayload();
      LAST_ORDER_PAYLOAD = {
        source: "noorarfa-rfq",
        mode: "ready",
        payment_method: pay || "Cash",
        shipping_method: DEFAULT_SHIPPING_METHOD,
        items: readyItems.map(i => ({
          sku: i.sku || '',
          name: i.name + ' ('+i.color+')' + (i.sewCode ? ` [Sew ${i.sewCode}]` : ''),
          qty: i.qty,
          unit_price: i.unitFabric + (i.sewPrice||0),
          amount: i.amount
        })),
        totals,
        customer
      };

      populateQuotation(itemsForInvoice, totals, pay);
      btnSubmitOrder.disabled = false;
    });

    // CUSTOM → RFQ
    btnRFQCustom?.addEventListener('click', () => {
      const pay = currentPaymentCustom();
      if (!customItems.length) { alert('Sila tambah sekurang-kurangnya satu item custom.'); return; }
      const totals = computeTotalsCustom(customItems, pay);

      const itemsForInvoice = customItems.map(ci => ({
        sku: '',
        desc: `${ci.material} – ${ci.pattern} (${ci.color}) [${ci.variantText}]`
              + (ci.sewCode ? ` [Sew ${ci.sewCode}]` : '')
              + (ci.addonLogo ? ` [Logo]` : ''),
        qty: ci.qty,
        unit: ci.unitCombined,
        amount: ci.totalCash
      }));

      const customer = collectCustomerForPayload();
      LAST_ORDER_PAYLOAD = {
        source: "noorarfa-rfq",
        mode: "custom",
        payment_method: pay || "Cash",
        shipping_method: DEFAULT_SHIPPING_METHOD,
        items: customItems.map(ci => ({
          sku: '',
          name: `${ci.material} – ${ci.pattern} (${ci.color}) [${ci.variantText}]`
                + (ci.sewCode ? ` [Sew ${ci.sewCode}]` : '')
                + (ci.addonLogo ? ` [Logo]` : ''),
          qty: ci.qty,
          unit_price: ci.unitCombined,
          amount: ci.totalCash
        })),
        totals,
        customer
      };

      populateQuotation(itemsForInvoice, totals, pay);
      btnSubmitOrder.disabled = false;
    });

    // SUBMIT ORDER → Google Sheets
    btnSubmitOrder.addEventListener('click', async () => {
      if (!LAST_ORDER_PAYLOAD) { alert('Sila jana quotation dahulu.'); return; }
      const ok = confirm('Hantar order ini ke Noor Arfa (Google Sheets)?');
      if (!ok) return;
      await sendToSheets(LAST_ORDER_PAYLOAD);
      // Optional: btnSubmitOrder.disabled = true;
    });

    // Default tab
    modeReady.checked = true; toggleSections();
  </script>

  <style>
    .invoice-table { border-collapse: collapse; width: 100%; }
    .invoice-table th, .invoice-table td { border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; padding: 8px 10px; }
    .invoice-table thead th { background:#f3f4f6; text-align:left; }
    @media print {
      body * { visibility: hidden !important; }
      #quotationSection, #quotationSection * { visibility: visible !important; }
      #quotationSection { position: absolute; left:0; top:0; width:100%; box-shadow:none !important; border-radius:0 !important; }
      .no-print { display:none !important; }
    }
  </style>
</body>
</html>
